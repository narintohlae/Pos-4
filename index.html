<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เว็บแอปเบิกสินค้า</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Papaparse for robust CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <!-- html2canvas for saving element as image -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- SortableJS for smooth drag and drop -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #3b82f6; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 2rem auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        table thead { position: sticky; top: 0; z-index: 10; background-color: #f1f5f9; }
        #cart-sidebar, #confirmation-modal { transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; }
        .modal-content, .page-content { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .cart-table th, .cart-table td { padding: 8px 4px; text-align: left; vertical-align: middle; }
        
        /* Drag and Drop Styles */
        .sortable-ghost { opacity: 0.4; background: #dbeafe; }
        .sortable-drag { opacity: 0.9 !important; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .drag-handle { cursor: grab; }
        .selected-row { background-color: #eff6ff !important; }
    </style>
</head>
<body class="antialiased text-slate-800">

    <div id="app-container" class="relative min-h-screen">
        
        <!-- Main View -->
        <div id="main-view" class="flex flex-col h-screen">
            <header class="bg-white border-b border-slate-50 px-1 py-1">
                 <div class="container mx-auto flex justify-between items-center">
                    <div class="flex items-center gap-1">
                        <button id="history-view-button" class="text-slate-500 hover:bg-slate-100 w-10 h-10 rounded-full transition-colors" title="ประวัติการเบิกของ">
                            <i class="fas fa-history"></i>
                        </button>
                        <button id="cart-button" class="relative text-slate-500 hover:bg-slate-100 w-10 h-10 rounded-full transition-colors" title="ตะกร้าสินค้า">
                            <i class="fas fa-shopping-cart"></i>
                            <span id="cart-badge" class="absolute top-0 right-0 flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-red-500 rounded-full hidden">0</span>
                        </button>
                    </div>
                </div>
            </header>
            
            <main class="container mx-auto p-3 sm:p-4 flex-grow flex flex-col">
                <div class="text-center mb-4 flex flex-col sm:flex-row justify-center items-center gap-2 sm:gap-4">
                     <button id="show-hidden-button" class="hidden text-xs sm:text-sm text-blue-600 font-semibold hover:underline">แสดงรายการที่ซ่อน</button>
                </div>

                <div id="data-container" class="bg-white rounded-xl shadow-lg overflow-hidden flex-grow flex flex-col">
                    <div id="table-wrapper" class="overflow-auto flex-grow">
                        <div id="loading" class="hidden"><div class="loader"></div><p class="text-center text-slate-500">กำลังโหลดข้อมูล...</p></div>
                        <div id="table-output"></div>
                        <div id="error-message" class="hidden p-8 text-center"><p class="text-red-600 font-semibold">เกิดข้อผิดพลาด</p><p class="text-slate-500 mt-2" id="error-text"></p></div>
                    </div>
                    <footer class="bg-white border-t border-slate-200 px-4 py-1 text-center">
                        <p id="table-info" class="text-xs text-slate-500 truncate"></p>
                    </footer>
                    <div id="sheet-tabs-container" class="bg-slate-100 border-t border-slate-200 flex items-center overflow-x-auto">
                        <!-- Sheet tabs will be injected here -->
                    </div>
                </div>
            </main>
        </div>

        <!-- History View -->
        <div id="history-view" class="hidden page-content">
             <main class="container mx-auto p-3 sm:p-4 md:p-8">
                <header class="flex justify-between items-center mb-6">
                    <h1 class="text-xl sm:text-2xl md:text-3xl font-bold text-slate-900">ประวัติการเบิกของ</h1>
                    <button id="back-to-main-button" class="text-white bg-indigo-600 hover:bg-indigo-700 font-semibold py-2 px-4 rounded-lg flex items-center gap-2">
                        <i class="fas fa-arrow-left"></i> กลับหน้าหลัก
                    </button>
                </header>
                <div id="history-list-container" class="space-y-3"></div>
             </main>
        </div>

        <!-- Shopping Cart Sidebar -->
        <div id="cart-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>
        <aside id="cart-sidebar" class="fixed top-0 right-0 h-full w-full max-w-sm bg-white shadow-xl z-50 transform translate-x-full flex flex-col">
            <div class="flex items-center justify-between p-4 border-b">
                <h2 class="text-xl font-bold">รายการเบิกของ</h2>
                <button id="close-cart-button" class="text-slate-500 hover:text-slate-800 p-2"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div id="cart-items" class="flex-grow p-4 overflow-y-auto">
                <p id="empty-cart-message" class="text-center text-slate-500 mt-8">ยังไม่มีรายการเบิกของ</p>
            </div>
            <div class="p-4 border-t bg-slate-50 grid grid-cols-2 gap-2">
                <div>
                    <span class="text-sm font-bold block">จำนวนรวม:</span>
                    <span id="cart-total-quantity" class="text-xl font-bold text-indigo-600">0 ชิ้น</span>
                </div>
                <button id="confirm-order-button" class="w-full py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors disabled:bg-slate-300 disabled:cursor-not-allowed">ยืนยันการเบิกของ</button>
                <button id="clear-cart-button" class="col-span-2 w-full mt-2 py-2 px-4 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition-colors">ล้างรายการเบิกของ</button>
            </div>
        </aside>

        <!-- Confirmation Modal -->
        <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-60 z-[60] hidden items-center justify-center p-4">
             <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-md flex flex-col">
                <div id="order-summary-content" class="p-6">
                    <div class="text-center mb-4">
                        <h3 class="text-2xl font-bold">สรุปรายการเบิกของ</h3>
                        <p id="order-id-display" class="text-sm text-slate-500 font-mono"></p>
                    </div>
                    <div id="order-details" class="text-sm border-t border-b py-2 my-2 max-h-64 overflow-y-auto"></div>
                    <div class="flex justify-between font-bold text-lg mt-4">
                        <span>จำนวนเบิกสุทธิ:</span>
                        <span id="order-total-quantity" class="text-indigo-600"></span>
                    </div>
                    <div id="db-status" class="text-center text-xs text-slate-400 mt-4 h-4"></div>
                </div>
                <div class="p-4 bg-slate-50 grid grid-cols-1 sm:grid-cols-2 gap-3 rounded-b-xl">
                    <button id="save-png-button" class="w-full py-2.5 px-4 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 flex items-center justify-center gap-2"><i class="fas fa-file-image"></i> บันทึก PNG</button>
                    <button id="share-line-button" class="w-full py-2.5 px-4 bg-[#06C755] text-white font-semibold rounded-lg hover:bg-[#05a546] flex items-center justify-center gap-2"><i class="fab fa-line"></i> แชร์ LINE</button>
                    <button id="close-modal-button" class="col-span-1 sm:col-span-2 mt-2 w-full py-2 px-4 bg-slate-200 text-slate-700 font-semibold rounded-lg hover:bg-slate-300">ปิด</button>
                </div>
             </div>
        </div>
    </div>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp, collection, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCFmPfvZMwgZacZfbh2CAnNbgudSGVhfeQ",
            authDomain: "inventory-rakya.firebaseapp.com",
            projectId: "inventory-rakya",
            storageBucket: "inventory-rakya.appspot.com",
            messagingSenderId: "832335850184",
            appId: "1:832335850184:web:69cc594ef302e8f7a753fd",
            measurementId: "G-J81YS36FN5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        document.addEventListener('DOMContentLoaded', () => {
            const BASE_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTHNXWH--q-dp4ziR3rCAKfKEKrYtbqgpJySy7MGS5sIf1p4oPUWq-N308LzvgAtQzKLpQzxIpBF-dy/pub?output=csv';
            const sheets = [ { name: 'Carnation', gid: '1202826527' }, { name: 'Dumilk', gid: '558528573' }, { name: 'Enfa', gid: '1686260164' }, { name: 'S-26', gid: '541838051' }, { name: 'Hi-q', gid: '2048095283' }, { name: 'Dumex', gid: '335261999' }, { name: 'Lactogen', gid: '541838051' }, { name: 'นมหมี', gid: '1107720102' }, { name: 'UHT', gid: '1569495958' }, { name: 'Ensure', gid: '1949963044' }, { name: 'Glucerna', gid: '1918336836' }, { name: 'MamyPoko', gid: '1243801307' }, { name: 'BabyLove', gid: '1599419486' }, { name: 'Molfix', gid: '1854621604' }, { name: 'Goon', gid: '1166178099' }, { name: 'DodoLove', gid: '1371683625' }, { name: 'Certainty', gid: '426207624' }, { name: 'ไลฟ์รี่', gid: '385223925' }, { name: 'D-Nee', gid: '392683454' }, { name: 'Kodomo', gid: '930076186' }, { name: 'Babi mild', gid: '2134227081' }, { name: 'Johnson', gid: '400235897' }, { name: 'Enfant', gid: '691776819' }, { name: 'แคร์', gid: '11208593' }, { name: 'Attoon', gid: '11208593' }, { name: 'Nuebabe', gid: '518139187' }, { name: 'Pigeon', gid: '7309826' }, { name: 'Nutur', gid: '92634505' }];
            
            const ui = {
                mainView: document.getElementById('main-view'),
                historyView: document.getElementById('history-view'),
                historyViewButton: document.getElementById('history-view-button'),
                backToMainButton: document.getElementById('back-to-main-button'),
                historyListContainer: document.getElementById('history-list-container'),
                sheetTabsContainer: document.getElementById('sheet-tabs-container'), 
                tableOutput: document.getElementById('table-output'),
                tableInfo: document.getElementById('table-info'), loading: document.getElementById('loading'),
                error: { el: document.getElementById('error-message'), text: document.getElementById('error-text') },
                showHiddenButton: document.getElementById('show-hidden-button'),
                cart: {
                    button: document.getElementById('cart-button'), badge: document.getElementById('cart-badge'),
                    overlay: document.getElementById('cart-overlay'), sidebar: document.getElementById('cart-sidebar'),
                    closeButton: document.getElementById('close-cart-button'), itemsContainer: document.getElementById('cart-items'),
                    emptyMessage: document.getElementById('empty-cart-message'), totalQuantityEl: document.getElementById('cart-total-quantity'),
                    clearButton: document.getElementById('clear-cart-button'), confirmButton: document.getElementById('confirm-order-button')
                },
                modal: {
                    el: document.getElementById('confirmation-modal'), closeButton: document.getElementById('close-modal-button'),
                    orderDetails: document.getElementById('order-details'), orderTotalQuantity: document.getElementById('order-total-quantity'),
                    orderIdDisplay: document.getElementById('order-id-display'), dbStatus: document.getElementById('db-status'),
                    savePngButton: document.getElementById('save-png-button'), shareLineButton: document.getElementById('share-line-button'),
                    summaryContent: document.getElementById('order-summary-content')
                }
            };
            
            let state = { activeTab: null, cart: new Map(), currentSheetData: [], productIdentifierHeader: '', unitHeader: '' };
            let currentlyViewedOrder = null;

            onAuthStateChanged(auth, (user) => {
                if (user) initializeAppLogic();
                else signInAnonymously(auth).catch(() => {
                    ui.error.text.textContent = "ไม่สามารถเชื่อมต่อฐานข้อมูลได้";
                    ui.error.el.classList.remove('hidden');
                });
            });

            function initializeAppLogic() {
                ui.tableOutput.addEventListener('click', handleTableClick);
                ui.tableOutput.addEventListener('dblclick', handleTableRowDoubleClick);
                ui.cart.itemsContainer.addEventListener('click', handleCartButtonClick);
                ui.cart.button.addEventListener('click', () => toggleCart(true));
                ui.cart.closeButton.addEventListener('click', () => toggleCart(false));
                ui.cart.overlay.addEventListener('click', () => toggleCart(false));
                ui.cart.clearButton.addEventListener('click', clearCart);
                ui.cart.confirmButton.addEventListener('click', () => showConfirmationModal());
                ui.modal.closeButton.addEventListener('click', () => toggleModal(false));
                ui.modal.savePngButton.addEventListener('click', saveOrderAsPng);
                ui.modal.shareLineButton.addEventListener('click', shareOrderToLine);
                ui.historyViewButton.addEventListener('click', showHistoryView);
                ui.backToMainButton.addEventListener('click', showMainView);
                ui.showHiddenButton.addEventListener('click', showAllHiddenRows);

                createSheetTabs();
                const firstTab = ui.sheetTabsContainer.querySelector('.sheet-tab');
                if (firstTab) firstTab.click();
                renderCart();
            }
            
            function showMainView() {
                ui.historyView.classList.add('hidden');
                ui.mainView.classList.remove('hidden');
            }
            
            async function showHistoryView() {
                ui.mainView.classList.add('hidden');
                ui.historyView.classList.remove('hidden');
                const container = ui.historyListContainer;
                container.innerHTML = `<div class="text-center py-8"><div class="loader"></div><p>กำลังโหลดประวัติ...</p></div>`;
                try {
                    const q = query(collection(db, "requests"), orderBy("createdAt", "desc"));
                    const querySnapshot = await getDocs(q);
                    if (querySnapshot.empty) {
                        container.innerHTML = `<div class="text-center py-12 text-slate-500"><i class="fas fa-box-open fa-3x mb-4"></i><p>ยังไม่มีประวัติการเบิกของ</p></div>`;
                        return;
                    }
                    container.innerHTML = '';
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const historyItem = document.createElement('button');
                        historyItem.className = 'w-full text-left bg-white p-4 rounded-lg shadow hover:bg-indigo-50 transition-colors flex justify-between items-center';
                        const date = data.createdAt?.toDate ? data.createdAt.toDate().toLocaleString('th-TH', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'ไม่มีข้อมูลวันที่';
                        historyItem.innerHTML = `<div><p class="font-bold text-indigo-700">${data.id}</p><p class="text-sm text-slate-500">${date}</p></div><div class="text-right"><p class="font-semibold">${data.totalQuantity} ชิ้น</p></div>`;
                        historyItem.addEventListener('click', () => { showConfirmationModal(data); });
                        container.appendChild(historyItem);
                    });
                } catch (error) {
                    console.error("Error fetching history: ", error);
                    container.innerHTML = `<div class="text-center py-12 text-red-500">เกิดข้อผิดพลาดในการโหลดประวัติ</div>`;
                }
            }
            
            async function getSheetPreferences() {
                const user = auth.currentUser;
                if (!user) return { order: [], hidden: [] };
                const gid = state.activeTab ? state.activeTab.dataset.gid : 'default';
                const docRef = doc(db, "user_preferences", user.uid);
                try {
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        return data[gid] || { order: [], hidden: [] };
                    }
                    return { order: [], hidden: [] };
                } catch (e) {
                    console.error("Error getting sheet preferences:", e);
                    return { order: [], hidden: [] };
                }
            }

            async function saveSheetPreference(preference) {
                const user = auth.currentUser;
                if (!user) return;
                const gid = state.activeTab ? state.activeTab.dataset.gid : 'default';
                const docRef = doc(db, "user_preferences", user.uid);
                try {
                    await setDoc(docRef, { [gid]: preference }, { merge: true });
                } catch (e) {
                    console.error("Error saving sheet preferences:", e);
                }
            }

            function handleTableClick(e) {
                const button = e.target.closest('.plus-btn, .minus-btn');
                if (button) {
                    const productId = button.dataset.id;
                    const change = button.classList.contains('plus-btn') ? 1 : -1;
                    updateProductQuantity(productId, change);
                    return;
                }

                const row = e.target.closest('tr');
                if (row && !e.target.closest('.order-cell, .drag-handle-cell')) {
                    ui.tableOutput.querySelectorAll('tr.selected-row').forEach(r => r.classList.remove('selected-row'));
                    row.classList.add('selected-row');
                }
            }
            
            async function handleTableRowDoubleClick(e) {
                const targetCell = e.target.closest('td');
                if (!targetCell || targetCell.classList.contains('order-cell') || targetCell.classList.contains('drag-handle-cell')) return;
                const rowToHide = targetCell.parentElement;
                const productId = rowToHide.dataset.id;
                if (rowToHide && rowToHide.tagName === 'TR' && productId) {
                    rowToHide.classList.add('hidden');
                    const prefs = await getSheetPreferences();
                    if (!(prefs.hidden || []).includes(productId)) {
                        prefs.hidden = [...(prefs.hidden || []), productId];
                        await saveSheetPreference({ order: prefs.order || [], hidden: prefs.hidden });
                    }
                    updateShowHiddenButton();
                }
            }

            async function showAllHiddenRows() {
                const prefs = await getSheetPreferences();
                const hiddenItems = prefs.hidden || [];
                ui.tableOutput.querySelectorAll('tbody tr').forEach(row => {
                    if (hiddenItems.includes(row.dataset.id)) row.classList.remove('hidden');
                });
                await saveSheetPreference({ order: prefs.order || [], hidden: [] });
                updateShowHiddenButton();
            }

            async function updateShowHiddenButton() {
                const prefs = await getSheetPreferences();
                const hiddenCount = prefs.hidden ? prefs.hidden.length : 0;
                if (hiddenCount > 0) {
                    ui.showHiddenButton.textContent = `แสดง ${hiddenCount} รายการที่ซ่อน`;
                    ui.showHiddenButton.classList.remove('hidden');
                } else {
                    ui.showHiddenButton.classList.add('hidden');
                }
            }

            function handleCartButtonClick(e) {
                 const target = e.target.closest('.cart-plus-btn, .cart-minus-btn');
                if (!target) return;
                const productId = target.dataset.id;
                const change = target.classList.contains('cart-plus-btn') ? 1 : -1;
                updateProductQuantity(productId, change);
            }
            
            function updateProductQuantity(productId, change) {
                updateCart(productId, change);
                const item = state.cart.get(productId);
                const newQuantity = item ? item.quantity : 0;
                const tableQuantitySpan = document.querySelector(`.quantity-display[data-id="${productId}"]`);
                if (tableQuantitySpan) tableQuantitySpan.textContent = newQuantity;
            }

            function toggleCart(open) {
                if (open) { ui.cart.overlay.classList.remove('hidden'); ui.cart.sidebar.classList.remove('translate-x-full'); } 
                else { ui.cart.overlay.classList.add('hidden'); ui.cart.sidebar.classList.add('translate-x-full'); }
            }
            
            function toggleModal(open) {
                 if(open) { ui.modal.el.classList.add('flex'); ui.modal.el.classList.remove('hidden'); }
                 else {
                     ui.modal.el.classList.add('hidden');
                     ui.modal.el.classList.remove('flex');
                     currentlyViewedOrder = null;
                 }
            }

            function updateCart(productId, change) {
                const productData = state.currentSheetData.find(p => p[state.productIdentifierHeader] === productId);
                if (!productData) return;
                const unit = productData[state.unitHeader] || 'ชิ้น';
                if (state.cart.has(productId)) {
                    const item = state.cart.get(productId);
                    item.quantity += change;
                    if (item.quantity <= 0) state.cart.delete(productId);
                    else state.cart.set(productId, item);
                } else if (change > 0) {
                    state.cart.set(productId, { name: productId, quantity: 1, unit: unit });
                }
                renderCart();
            }

            function renderCart() {
                ui.cart.itemsContainer.innerHTML = '';
                let totalItems = 0;
                if (state.cart.size === 0) {
                    ui.cart.itemsContainer.appendChild(ui.cart.emptyMessage);
                    ui.cart.emptyMessage.classList.remove('hidden');
                    ui.cart.confirmButton.disabled = true;
                } else {
                    ui.cart.emptyMessage.classList.add('hidden');
                    ui.cart.confirmButton.disabled = false;
                    const table = document.createElement('table');
                    table.className = 'w-full text-sm cart-table';
                    table.innerHTML = `<thead class="bg-slate-100"><tr><th class="font-semibold text-slate-600 w-12 text-center">ลำดับ</th><th class="font-semibold text-slate-600">สินค้า</th><th class="font-semibold text-slate-600 text-center w-28">จำนวน</th><th class="font-semibold text-slate-600 w-16">หน่วย</th></tr></thead><tbody></tbody>`;
                    const tbody = table.querySelector('tbody');
                    let index = 1;
                    state.cart.forEach(item => {
                        totalItems += item.quantity;
                        const row = tbody.insertRow();
                        row.innerHTML = `<td class="text-center">${index++}</td><td class="font-semibold">${item.name}</td><td class="text-center"><div class="flex items-center justify-center"><button class="cart-minus-btn inline-flex items-center justify-center w-6 h-6 text-sm font-bold text-red-600 bg-red-100 rounded-full hover:bg-red-200" data-id="${item.name}">-</button><span class="font-bold text-base mx-2 w-8 text-center">${item.quantity}</span><button class="cart-plus-btn inline-flex items-center justify-center w-6 h-6 text-sm font-bold text-green-600 bg-green-100 rounded-full hover:bg-green-200" data-id="${item.name}">+</button></div></td><td>${item.unit}</td>`;
                    });
                    ui.cart.itemsContainer.appendChild(table);
                }
                ui.cart.totalQuantityEl.textContent = `${totalItems} ชิ้น`;
                if (totalItems > 0) { ui.cart.badge.textContent = totalItems; ui.cart.badge.classList.remove('hidden'); } 
                else { ui.cart.badge.classList.add('hidden'); }
            }

            function clearCart() {
                state.cart.clear();
                document.querySelectorAll('.quantity-display').forEach(span => span.textContent = '0');
                renderCart();
                toggleModal(false);
            }
            
            function showConfirmationModal(historyData = null) {
                let orderId, items, totalItems;
                ui.modal.dbStatus.innerHTML = '';
                if (historyData) {
                    currentlyViewedOrder = historyData;
                    orderId = historyData.id;
                    items = Array.isArray(historyData.items) ? historyData.items : [];
                    totalItems = historyData.totalQuantity;
                    ui.modal.dbStatus.innerHTML = `<i class="fas fa-check-circle text-green-500"></i> บันทึกในฐานข้อมูลแล้ว`;
                } else {
                    if (state.cart.size === 0) return;
                    currentlyViewedOrder = null;
                    const now = new Date();
                    orderId = `RO-${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}-${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}${now.getSeconds().toString().padStart(2, '0')}`;
                    items = Array.from(state.cart.values());
                    totalItems = items.reduce((sum, item) => sum + item.quantity, 0);
                    const itemsForDb = items.map(item => ({ name: item.name, quantity: item.quantity, unit: item.unit }));
                    saveRequestToFirestore(orderId, itemsForDb, totalItems);
                }
                ui.modal.orderIdDisplay.textContent = `เลขที่ใบเบิกของ: ${orderId}`;
                const table = document.createElement('table');
                table.className = 'w-full text-sm';
                table.innerHTML = `<thead class="border-b"><tr><th class="py-1 text-center font-semibold w-12">ลำดับ</th><th class="py-1 text-left font-semibold">สินค้า</th><th class="py-1 text-center font-semibold">จำนวน</th><th class="py-1 text-left font-semibold">หน่วย</th></tr></thead><tbody></tbody>`;
                const tbody = table.querySelector('tbody');
                let index = 1;
                items.forEach(item => {
                    const row = tbody.insertRow();
                    row.innerHTML = `<td class="py-1 text-center">${index++}</td><td class="py-1">${item.name}</td><td class="py-1 text-center">${item.quantity}</td><td class="py-1">${item.unit}</td>`;
                });
                ui.modal.orderDetails.innerHTML = '';
                ui.modal.orderDetails.appendChild(table);
                ui.modal.orderTotalQuantity.textContent = `${totalItems} ชิ้น`;
                toggleModal(true);
            }
            
            async function saveRequestToFirestore(orderId, items, totalQuantity) {
                if (!auth.currentUser) { ui.modal.dbStatus.textContent = "ข้อผิดพลาด: ไม่ได้เชื่อมต่อฐานข้อมูล"; return; }
                ui.modal.dbStatus.textContent = "กำลังบันทึกข้อมูล...";
                try {
                    const requestData = { id: orderId, createdAt: serverTimestamp(), totalQuantity: totalQuantity, items: items, user: auth.currentUser.uid, };
                    await setDoc(doc(db, "requests", orderId), requestData);
                    ui.modal.dbStatus.innerHTML = `<i class="fas fa-check-circle text-green-500"></i> บันทึกในฐานข้อมูลแล้ว`;
                } catch (error) { ui.modal.dbStatus.textContent = "เกิดข้อผิดพลาดในการบันทึก"; }
            }

            async function saveOrderAsPng() {
                const button = ui.modal.savePngButton;
                const originalText = button.innerHTML;
                button.innerHTML = `<i class="fas fa-spinner fa-spin"></i> กำลังบันทึก...`;
                button.disabled = true;
                try {
                    const canvas = await html2canvas(ui.modal.summaryContent, { scale: 2, backgroundColor: '#ffffff' });
                    const link = document.createElement('a');
                    link.download = `${ui.modal.orderIdDisplay.textContent.replace(':', '')}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                } catch(err) { alert("เกิดข้อผิดพลาดในการบันทึกรูปภาพ"); } 
                finally { button.innerHTML = originalText; button.disabled = false; }
            }

            function shareOrderToLine() {
                const orderIdText = ui.modal.orderIdDisplay.textContent;
                let shareText = `*${orderIdText}*\n--------------------\n`;
                let totalItems = 0;
                let itemsToShare = [];
                if (currentlyViewedOrder) {
                    itemsToShare = Array.isArray(currentlyViewedOrder.items) ? currentlyViewedOrder.items : [];
                } else {
                    itemsToShare = Array.from(state.cart.values());
                }
                itemsToShare.forEach(item => {
                    totalItems += (item.quantity || 0);
                    shareText += `• ${item.name} (จำนวน: ${item.quantity || 0} ${item.unit || 'ชิ้น'})\n`;
                });
                shareText += `--------------------\n*จำนวนเบิกสุทธิ: ${totalItems} ชิ้น*`;
                const encodedText = encodeURIComponent(shareText);
                window.open(`https://line.me/R/msg/text/?${encodedText}`, '_blank');
            }
            
            async function loadSheet(tabElement) {
                ui.loading.classList.remove('hidden');
                ui.tableOutput.innerHTML = '';
                ui.error.el.classList.add('hidden');
                if (ui.tableInfo) {
                    ui.tableInfo.textContent = 'กำลังโหลดข้อมูล...';
                }
                if(state.activeTab) {
                    state.activeTab.classList.remove('bg-white', 'text-indigo-600', 'border-indigo-500');
                    state.activeTab.classList.add('border-transparent');
                }
                
                tabElement.classList.add('bg-white', 'text-indigo-600', 'border-indigo-500');
                tabElement.classList.remove('border-transparent');
                state.activeTab = tabElement;
                const url = `${BASE_URL}&gid=${tabElement.dataset.gid}`;
                await renderTableWithPapaParse(url);
            }
            
            async function renderTableWithPapaParse(url) {
                const prefs = await getSheetPreferences();
                const savedOrder = prefs.order || [];
                const hiddenItems = prefs.hidden || [];
                
                Papa.parse(url, {
                    download: true, header: true, skipEmptyLines: true, dynamicTyping: true,
                    complete: function(results) {
                        if (results.errors.length > 0) { throw new Error(`เกิดข้อผิดพลาดในการแปลง CSV: ${results.errors[0].message}`); }
                        
                        const headers = results.meta.fields;
                        let parsedData = results.data;
                        state.productIdentifierHeader = headers[0];
                        state.unitHeader = headers.find(h => h.toLowerCase().includes('หน่วย')) || headers[2];
                        
                        if (savedOrder.length > 0) {
                            const orderedData = savedOrder.map(id => parsedData.find(p => p && p[state.productIdentifierHeader] === id)).filter(Boolean);
                            const newItems = parsedData.filter(p => p && !savedOrder.includes(p[state.productIdentifierHeader]));
                            parsedData = [...orderedData, ...newItems];
                        }
                        state.currentSheetData = parsedData;

                        if (state.currentSheetData.length === 0 || !headers || headers.length === 0) {
                            ui.tableOutput.innerHTML = '<p class="text-center p-8 text-slate-500">ไม่พบข้อมูลในชีทนี้</p>';
                            if (ui.tableInfo) ui.tableInfo.textContent = 'ชีทนี้ว่างเปล่า';
                            ui.loading.classList.add('hidden');
                            return;
                        }
                        
                        const table = document.createElement('table');
                        table.className = 'min-w-full';
                        const thead = document.createElement('thead');
                        const headerRow = document.createElement('tr');
                        const displayHeaders = headers.filter(h => !h.toLowerCase().includes('ราคา'));
                        
                        headerRow.innerHTML = `<th class="px-2 py-3 w-8"></th>` + 
                            displayHeaders.map(h => `<th class="px-3 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sm:px-6">${h}</th>`).join('') +
                            `<th class="px-3 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider sm:px-6">เบิกของ</th>`;
                        thead.appendChild(headerRow);
                        table.appendChild(thead);

                        const tbody = document.createElement('tbody');
                        tbody.id = "product-table-body";
                        tbody.className = "bg-white divide-y divide-slate-200";
                        state.currentSheetData.forEach(rowObject => {
                            const productId = rowObject[state.productIdentifierHeader];
                            if(!productId) return;
                            const tr = document.createElement('tr');
                            tr.dataset.id = productId;
                            if (hiddenItems.includes(productId)) tr.classList.add('hidden');

                            const itemInCart = state.cart.get(productId);
                            tr.innerHTML = `<td class="px-2 py-1.5 text-center text-slate-400 drag-handle-cell"><i class="fas fa-grip-vertical drag-handle"></i></td>` +
                                displayHeaders.map(header => `<td class="px-3 py-1.5 whitespace-nowrap text-sm text-slate-700 sm:px-6">${rowObject[header] ?? ''}</td>`).join('') +
                                `<td class="px-3 py-1.5 whitespace-nowrap text-sm text-slate-700 order-cell sm:px-6">
                                    <div class="flex items-center justify-center order-controls">
                                        <button class="minus-btn inline-flex items-center justify-center w-6 h-6 text-sm font-bold text-indigo-600 bg-indigo-100 rounded-full hover:bg-indigo-200 focus:outline-none" data-id="${productId}">-</button>
                                        <span class="quantity-display font-bold text-base mx-2 w-8 text-center" data-id="${productId}">${itemInCart ? itemInCart.quantity : '0'}</span>
                                        <button class="plus-btn inline-flex items-center justify-center w-6 h-6 text-sm font-bold text-indigo-600 bg-indigo-100 rounded-full hover:bg-indigo-200 focus:outline-none" data-id="${productId}">+</button>
                                    </div>
                                </td>`;
                            tbody.appendChild(tr);
                        });
                        table.appendChild(tbody);
                        ui.tableOutput.innerHTML = '';
                        ui.tableOutput.appendChild(table);

                        new Sortable(tbody, {
                            animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost', dragClass: 'sortable-drag',
                            onEnd: async function (evt) {
                                const newOrder = Array.from(evt.to.children).map(tr => tr.dataset.id);
                                const prefs = await getSheetPreferences();
                                prefs.order = newOrder;
                                await saveSheetPreference(prefs);
                            },
                        });

                        if (ui.tableInfo) ui.tableInfo.textContent = `แสดงข้อมูล ${state.currentSheetData.length} รายการ`;
                        ui.loading.classList.add('hidden');
                        updateShowHiddenButton();
                    },
                    error: function(error) {
                        ui.error.text.textContent = "ไม่สามารถดาวน์โหลดข้อมูลจากชีทได้";
                        ui.error.el.classList.remove('hidden');
                        if (ui.tableInfo) ui.tableInfo.textContent = 'ไม่สามารถโหลดข้อมูลได้';
                        ui.loading.classList.add('hidden');
                    }
                });
            }

            function createSheetTabs() {
                ui.sheetTabsContainer.innerHTML = ''; // Clear existing tabs
                sheets.forEach((sheet, index) => {
                    const tab = document.createElement('button');
                    tab.textContent = sheet.name;
                    // MODIFIED: Added divider logic within the class
                    tab.className = 'sheet-tab px-3 sm:px-4 py-2 text-sm font-semibold text-slate-600 border-b-4 border-transparent hover:text-indigo-600 whitespace-nowrap border-l border-slate-200 first:border-l-0';
                    tab.dataset.gid = sheet.gid;
                    tab.addEventListener('click', () => loadSheet(tab));
                    ui.sheetTabsContainer.appendChild(tab);
                });
            }
        });
    </script>
</body>
</html>
